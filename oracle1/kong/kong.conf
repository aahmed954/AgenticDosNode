# Kong Configuration for ARM64 Ubuntu-based image
# Optimized for Oracle Ampere CPU

# Database Configuration
database = postgres
pg_host = postgres
pg_port = 5432
pg_database = kong
pg_user = agentic
pg_password = changeme
pg_ssl = off
pg_ssl_verify = off

# ARM64 Performance Optimizations
nginx_worker_processes = auto
nginx_daemon = off
nginx_worker_connections = 16384

# Memory optimizations for ARM64
mem_cache_size = 256m
nginx_http_client_body_buffer_size = 8k
nginx_http_client_header_buffer_size = 1k
nginx_http_large_client_header_buffers = 8 16k

# Upstream optimizations
upstream_keepalive_pool_size = 60
upstream_keepalive_max_requests = 100
upstream_keepalive_idle_timeout = 60

# Admin API
admin_listen = 0.0.0.0:8001
admin_access_log = /dev/stdout
admin_error_log = /dev/stderr

# Proxy
proxy_listen = 0.0.0.0:8000, 0.0.0.0:8443 ssl
proxy_access_log = /dev/stdout
proxy_error_log = /dev/stderr

# SSL Configuration (if needed)
ssl_cert = /usr/local/kong/ssl/kong.crt
ssl_cert_key = /usr/local/kong/ssl/kong.key
ssl_cipher_suite = modern
ssl_protocols = TLSv1.2 TLSv1.3

# Plugins
plugins = bundled,prometheus,request-transformer,rate-limiting,jwt,cors,key-auth

# Rate limiting
rate_limiting_policy = local
rate_limiting_sync_rate = 2

# Logging
log_level = notice
prefix = /usr/local/kong/

# Health checks
nginx_http_status_listen = 0.0.0.0:8100

# DNS resolver for ARM64
dns_resolver = 8.8.8.8,8.8.4.4
dns_hostsfile = /etc/hosts
dns_order = LAST,SRV,A,CNAME

# Clustering (if needed)
cluster_control_plane = 127.0.0.1:8005
cluster_listen = 0.0.0.0:8005
cluster_telemetry_endpoint = 127.0.0.1:8006

# Optimize for Oracle Cloud Network
trusted_ips = 0.0.0.0/0,::/0
real_ip_header = X-Real-IP
real_ip_recursive = on